<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PowerNotes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;padding:16px;font-family:sans-serif;font-size:16px;}
section{max-width:800px;margin:auto;position:relative;}
[hidden]{display:none;}
input,button{font-size:16px;margin:4px 0;}
ul{padding-left:0;}
li{list-style:none;padding:8px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;position:relative;user-select:none;}
li:hover{background:#f5f5f5;}
#title{width:100%;font-size:20px;margin:8px 0;border:none;padding:0;box-sizing:border-box;}
#editor{min-height:70vh;outline:none;white-space:pre-wrap;word-break:break-word;border-top:1px solid #ccc;padding-top:16px;}
img{max-width:100%;display:block;margin:8px 0;}
.video{position:relative;width:100%;padding-top:56.25%;margin:12px auto;}
.video iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}
@media(max-width:768px){.video{max-width:100%;}}
.memo-right{display:flex;align-items:center;gap:8px;}
.date-span{font-size:0.7em;color:#666;}
.menu-btn{background:none;border:none;font-size:16px;cursor:pointer;}
.menu-popup{position:absolute;top:100%;right:0;background:#fff;border:1px solid #ccc;padding:4px 0;box-shadow:0 2px 6px rgba(0,0,0,0.2);display:none;z-index:10;}
.menu-popup button{width:100%;text-align:left;padding:4px 12px;background:none;border:none;cursor:pointer;}
.menu-popup button:hover{background:#eee;}
#user-icon{width:32px;height:32px;border-radius:50%;cursor:pointer;position:relative;}
#user-menu{position:absolute;top:40px;right:0;background:#fff;border:1px solid #ccc;display:none;z-index:100;white-space:nowrap;}
#toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:12px 24px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity 0.3s ease;z-index:1000;}
#toast.show{opacity:1;pointer-events:auto;}
.preview-popup{position:fixed;background:#fff;border:1px solid #333;padding:8px;z-index:1000;max-width:80%;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
button{cursor:pointer;}
.flex-between{display:flex;justify-content:space-between;align-items:center;}
</style>
</head>
<body>

<!-- Login -->
<section id="view-login">
  <h2>PowerNotes Login</h2>
  <input id="email" placeholder="email"><br>
  <input id="password" type="password" placeholder="password"><br>
  <button id="login">Login</button>
  <button id="signup">Sign up</button><br><br>
  <button id="google-login">Login with Google</button>
</section>

<!-- Notes List -->
<section id="view-list" hidden>
  <div class="flex-between">
    <h2>Notes</h2>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="new-memo">New</button>
      <button id="go-trash">Trash</button>
      <img id="user-icon" src="" title="User Menu">
      <div id="user-menu">
        <button id="switch-account">アカウント切替</button>
        <button id="logout-btn">ログアウト</button>
      </div>
    </div>
  </div>
  <ul id="memo-list"></ul>
</section>

<!-- Trash -->
<section id="view-trash" hidden>
  <div class="flex-between">
    <h2>Trash</h2>
    <button id="back-list">← Back</button>
  </div>
  <ul id="trash-list"></ul>
</section>

<!-- Editor -->
<section id="view-editor" hidden>
  <button id="back">← Back</button>
  <input id="title" placeholder="">
  <div id="editor" contenteditable="true"></div>
</section>

<div id="toast"></div>

<div id="preview" class="preview-popup" hidden>
  <div id="preview-content"></div>
  <button id="copy-note">Copy</button>
  <button id="delete-note">Delete</button>
  <button id="close-preview">Close</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ---------------- Firebase 初期化 ---------------- */
const firebaseConfig = { apiKey:"AIzaSyCdDf0GH80PoGlcbk2yjlaVQfP01Gk9m18", authDomain:"noteeditor-ba1db.firebaseapp.com", projectId:"noteeditor-ba1db" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------------- DOM ---------------- */
const views={login:document.getElementById('view-login'),list:document.getElementById('view-list'),trash:document.getElementById('view-trash'),editor:document.getElementById('view-editor')};
const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');
const memoList=document.getElementById('memo-list');
const trashList=document.getElementById('trash-list');
const editor=document.getElementById('editor');
const titleInput=document.getElementById('title');
const userIcon=document.getElementById('user-icon');
const userMenu=document.getElementById('user-menu');
const toast=document.getElementById('toast');
const preview=document.getElementById('preview');
const previewContent=document.getElementById('preview-content');
const copyBtn=document.getElementById('copy-note');
const deleteBtn=document.getElementById('delete-note');
const closePreview=document.getElementById('close-preview');

let currentMemoId=null;
let longPressTimer=null;

/* ---------------- Helpers ---------------- */
function showToast(msg,d=2000){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),d); }
function show(view){ Object.values(views).forEach(v=>v.hidden=true); views[view].hidden=false; }

/* ---------------- Auth ---------------- */
const provider=new GoogleAuthProvider();

document.getElementById('login').onclick=()=>signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
document.getElementById('signup').onclick=()=>createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
document.getElementById('google-login').onclick=async()=>{ try{ await signInWithPopup(auth,provider); } catch(e){ alert("エラー\n"+e.code); } }

userIcon.onclick=()=>{ userMenu.style.display=(userMenu.style.display==='block')?'none':'block'; }
document.getElementById('switch-account').onclick=async()=>{ userMenu.style.display='none'; try{ await signInWithPopup(auth,provider); } catch(e){ alert("切替失敗"); } }
document.getElementById('logout-btn').onclick=()=>{ userMenu.style.display='none'; signOut(auth); location.href='/index.html#/login'; }

onAuthStateChanged(auth,user=>{
  if(user){
    if(user.photoURL) userIcon.src=user.photoURL;
    location.href = '/index.html#/list';
  } else location.href='/index.html#/login';
});

/* ---------------- Load Memos ---------------- */
async function loadMemos(){
  memoList.innerHTML='';
  const q=query(collection(db,'users',auth.currentUser.uid,'memos'),orderBy('updated','desc'));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    const data=d.data();
    if(data.deletedAt) return;
    const li=document.createElement('li');
    li.textContent=data.title||'Untitled';
    const rightDiv=document.createElement('div'); rightDiv.className='memo-right';
    const dateSpan=document.createElement('span'); dateSpan.className='date-span';
    dateSpan.textContent=new Date(data.updated).toLocaleString([],{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const menuBtn=document.createElement('button'); menuBtn.textContent='…'; menuBtn.className='menu-btn';
    const menuPopup=document.createElement('div'); menuPopup.className='menu-popup';
    const copyAction=document.createElement('button'); copyAction.textContent='Copy'; copyAction.onclick=async(e)=>{ e.stopPropagation(); navigator.clipboard.writeText(data.content||''); showToast('Copied'); menuPopup.style.display='none'; }
    const deleteAction=document.createElement('button'); deleteAction.textContent='Delete'; deleteAction.onclick=async(e)=>{ e.stopPropagation(); await setDoc(doc(db,'users',auth.currentUser.uid,'memos',d.id),{deletedAt:Date.now()},{merge:true}); li.remove(); showToast('Moved to Trash'); menuPopup.style.display='none'; }
    menuPopup.append(copyAction,deleteAction);
    menuBtn.onclick=(e)=>{ e.stopPropagation(); menuPopup.style.display=(menuPopup.style.display==='block')?'none':'block'; }
    rightDiv.append(dateSpan,menuBtn,menuPopup);
    li.appendChild(rightDiv);

    li.addEventListener('mousedown',()=>{ longPressTimer=setTimeout(()=>{ showPreview(d.id,data.title,data.content); },500); });
    li.addEventListener('mouseup',()=>{ clearTimeout(longPressTimer); });
    li.addEventListener('mouseleave',()=>{ clearTimeout(longPressTimer); });

    li.onclick=()=> location.href=`/index.html#/editor/${d.id}`;
    memoList.appendChild(li);
  });
}

/* ---------------- Trash ---------------- */
async function loadTrash(){
  trashList.innerHTML='';
  const thirtyDaysAgo = Date.now() - 30*24*60*60*1000;
  const q=query(collection(db,'users',auth.currentUser.uid,'memos'),orderBy('deletedAt','desc'));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    const data=d.data();
    if(!data.deletedAt || data.deletedAt<thirtyDaysAgo) return;
    const li=document.createElement('li');
    li.textContent=data.title||'Untitled';
    const rightDiv=document.createElement('div'); rightDiv.className='memo-right';
    const dateSpan=document.createElement('span'); dateSpan.className='date-span';
    dateSpan.textContent=new Date(data.deletedAt).toLocaleString([],{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const restoreBtn=document.createElement('button'); restoreBtn.textContent='Restore'; restoreBtn.onclick=async(e)=>{ e.stopPropagation(); await setDoc(doc(db,'users',auth.currentUser.uid,'memos',d.id),{deletedAt:null},{merge:true}); li.remove(); showToast('Restored'); }
    const deleteBtn=document.createElement('button'); deleteBtn.textContent='Delete'; deleteBtn.onclick=async(e)=>{ e.stopPropagation(); await setDoc(doc(db,'users',auth.currentUser.uid,'memos',d.id),{deletedAt:Date.now()-31*24*60*60*1000},{merge:true}); li.remove(); showToast('Deleted'); }
    rightDiv.append(dateSpan,restoreBtn,deleteBtn);
    li.appendChild(rightDiv);
    trashList.appendChild(li);
  });
}

/* ---------------- Editor ---------------- */
async function openEditor(id){
  currentMemoId=id;
  const snap=await getDoc(doc(db,'users',auth.currentUser.uid,'memos',id));
  const data=snap.data();
  titleInput.value=data.title||'';
  editor.innerHTML=data.content||'';
  show('editor');
}
async function saveMemo(){
  if(!currentMemoId) return;
  let title=titleInput.value.trim();
  if(!title) title=editor.innerText.split('\n')[0].trim()||'';
  await setDoc(doc(db,'users',auth.currentUser.uid,'memos',currentMemoId),{title,content:editor.innerHTML,updated:Date.now()},{merge:true});
}
editor.addEventListener('input',saveMemo);
titleInput.addEventListener('input',saveMemo);

/* ---------------- 画像貼り付け ---------------- */
editor.addEventListener('paste', async e => {
  const items = e.clipboardData.items;
  const range = document.getSelection().getRangeAt(0);
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      const file = item.getAsFile();
      const fileRef = ref(storage, `users/${auth.currentUser.uid}/images/${Date.now()}-${file.name}`);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);
      const img = document.createElement('img');
      img.src = url;
      range.insertNode(img);
      range.collapse(false);
      saveMemo();
      return;
    }
  }
});

/* ---------------- Preview ---------------- */
function showPreview(id,title,content){
  previewContent.innerHTML=`<strong>${title}</strong><br>${content}`;
  preview.hidden=false;
  copyBtn.onclick=()=>{ navigator.clipboard.writeText(content||''); showToast('Copied'); }
  deleteBtn.onclick=async()=>{ await setDoc(doc(db,'users',auth.currentUser.uid,'memos',id),{deletedAt:Date.now()},{merge:true}); preview.hidden=true; loadMemos(); showToast('Moved to Trash'); }
  closePreview.onclick=()=>preview.hidden=true;
}

/* ---------------- Navigation ---------------- */
window.addEventListener('load', navigate);
window.addEventListener('hashchange', navigate);

function navigate(){
  const hash = location.hash;
  if(hash.startsWith('#/editor/')) openEditor(hash.split('/')[2]);
  else if(hash === '#/list' || hash==='') { show('list'); loadMemos(); }
  else if(hash === '#/trash') { show('trash'); loadTrash(); }
  else if(hash === '#login') show('login');
}

/* ---------------- ボタン URL 指定 ---------------- */
document.getElementById('back').onclick = () => location.href = '/index.html#/list';
document.getElementById('back-list').onclick = () => location.href = '/index.html#/list';
document.getElementById('go-trash').onclick = () => location.href = '/index.html#/trash';
document.getElementById('new-memo').onclick = async () => {
  const refDoc = await addDoc(collection(db,'users',auth.currentUser.uid,'memos'), {title:'', content:'', updated:Date.now(), deletedAt:null});
  location.href = `/index.html#/editor/${refDoc.id}`;
};
</script>
</body>
</html>
